# Golang `sync` 套件完整整理筆記

## ✅ 功能總覽表

| 類型        | 名稱            | 用途說明                                           | 使用場景                                | 特性/限制說明                                |
|-------------|------------------|----------------------------------------------------|------------------------------------------|------------------------------------------------|
| 一次性操作  | `sync.Once`      | 確保某段程式只執行一次                           | 初始化全域變數、載入設定檔              | thread-safe，不能 reset                        |
| 鎖          | `sync.Mutex`     | 保護關鍵區域，確保同時間只有一個 goroutine 執行 | 串改共享變數、操作臨界資源              | 不可重入，忘記 Unlock 會死鎖                   |
| 鎖（讀寫分離）| `sync.RWMutex`  | 支援多讀單寫                                     | 資料查詢遠多於寫入時                     | 讀可併發，寫排他                               |
| 等待        | `sync.WaitGroup` | 等待一組 goroutines 完成                         | 串行化工作流程，等所有任務結束再繼續    | 無法重複使用同一 goroutine 做 Add / Done       |
| 共享資源池  | `sync.Pool`      | 物件重用，減少 GC 壓力                           | 重複產生臨時 buffer / 結構體             | 無容量限制，GC 時自動清空                      |
| 喚醒/通知   | `sync.Cond`      | 建立條件變數，用來協調喚醒 goroutine             | 生產者消費者模型，條件式同步             | 使用前需綁定 Mutex，較進階                     |
| 原子操作    | `sync/atomic`    | 提供原子操作避免鎖                              | 高效更新計數器、flag，適合低延遲情境     | 只能處理基本類型（int32/int64/uint32...）       |
| 併發 map    | `sync.Map`       | 內建鎖機制的併發安全 map                        | 多讀少寫的快取結構、統計表               | 不支援泛型、API 特殊、適合多讀少寫             |

---

## 🔥 面試常問解析

**Q1: `sync.Mutex` vs `sync.Once` 差在哪？**  
A1: `Mutex` 用於多次 lock/unlock 保護臨界區；`Once` 用於保證某段程式碼僅執行一次，無法 reset。

**Q2: `sync.Pool` 怎麼幫助效能？**  
A2: 透過重複使用物件避免頻繁 GC，適合重建成本高、生命周期短的 buffer。

**Q3: `sync.WaitGroup` 有什麼使用陷阱？**  
A3: 不應在 goroutine 中做 Add()，容易發生 Done 執行在 Add 前的錯誤。

**Q4: `sync.Map` 什麼場景適合？**  
A4: 多 goroutine 同時讀取、偶爾寫入，無需手動加鎖；例如快取、token 統計。

**Q5: RWMutex 什麼時候比 Mutex 好？**  
A5: 在明顯多讀少寫的場景才建議使用，否則判斷開銷可能更差。

---

## 📌 實作建議小結

| 建議                                | 原因與背景                                    |
|-------------------------------------|-----------------------------------------------|
| 能用 `Once` 就避免手動加鎖初始化    | 簡化邏輯，避免 race                            |
| 小型結構可搭配 `Pool` 使用          | 減少 GC 壓力                                   |
| 高頻寫操作不要用 `sync.Map`         | 效能不佳，建議用 map + RWMutex                |
| 注意 `Cond` 和 `WaitGroup` 的使用時機 | Cond 適合喚醒場景，WaitGroup 處理收尾邏輯     |
| 精簡原子更新可用 `sync/atomic`       | 避免不必要的鎖開銷，注意原子操作非複合邏輯安全 |

---

熟練掌握 `sync` 套件，是 Go Staff Engineer 在設計高效、安全、高併發系統時不可或缺的能力之一。