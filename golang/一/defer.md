
# ğŸª Golang defer é‡é»æ•´ç†

---

## ğŸ§  defer æ˜¯ä»€éº¼ï¼Ÿ

- `defer` æ˜¯ Golang çš„å»¶é²åŸ·è¡Œèªæ³•
- è¡¨ç¤ºåœ¨ **å‡½æ•¸è¿”å›ä¹‹å‰åŸ·è¡Œçš„èªå¥**
- å¸¸ç”¨æ–¼ï¼šè³‡æºé‡‹æ”¾ã€è§£é–ã€ç´€éŒ„ã€éŒ¯èª¤è™•ç†

```go
func main() {
    defer fmt.Println("world")
    fmt.Println("hello")
}
// è¼¸å‡ºé †åºï¼šhello â†’ world
```

---

## ğŸ§¾ åŸ·è¡Œæ™‚æ©Ÿèˆ‡ç‰¹æ€§

| ç‰¹æ€§               | èªªæ˜ |
|--------------------|------|
| åŸ·è¡Œæ™‚æ©Ÿ           | åœ¨**ç•¶å‰å‡½æ•¸ return ä¹‹å‰**åŸ·è¡Œ |
| å¾Œé€²å…ˆå‡ºï¼ˆLIFOï¼‰   | å¤šå€‹ defer æœƒé€†åºåŸ·è¡Œ         |
| åƒæ•¸ç«‹å³æ±‚å€¼       | defer èªå¥å®£å‘Šç•¶ä¸‹å°±è¨ˆç®—åƒæ•¸ï¼Œä¸ç­‰åˆ°çœŸæ­£åŸ·è¡Œæ™‚ |

```go
func test() {
    x := 1
    defer fmt.Println(x) // é€™è£¡ x å·²ç¶“æ˜¯ 1
    x = 10
}
```

---

## ğŸ” å¤šå€‹ defer çš„åŸ·è¡Œé †åºï¼ˆLIFOï¼‰

```go
func main() {
    defer fmt.Println("A")
    defer fmt.Println("B")
    defer fmt.Println("C")
}
// è¼¸å‡ºï¼šC â†’ B â†’ A
```

---

## âš ï¸ defer æ­é… return çš„ç´°ç¯€

```go
func foo() int {
    x := 5
    defer func() {
        x += 1
    }()
    return x // å‚³å›å€¼ç‚º 5ï¼Œä¸æ˜¯ 6
}
```

### ğŸ“Œ åŸå› ï¼š
- `return x` æ˜¯**å€¼å·²ç¶“è¢«è¤‡è£½**å¾Œï¼Œæ‰åŸ·è¡Œ deferã€‚
- é™¤é return æ˜¯å‘½åå›å‚³å€¼ï¼Œæ‰å¯èƒ½è¢« defer ä¿®æ”¹ã€‚

```go
func bar() (x int) {
    defer func() {
        x += 1
    }()
    return 5 // å›å‚³å€¼è®Šæˆ 6
}
```

---

## ğŸ” å¸¸è¦‹ç”¨é€”ç¯„ä¾‹

### âœ… è§£é–è³‡æº

```go
mu.Lock()
defer mu.Unlock()
```

### âœ… é—œé–‰æª”æ¡ˆæˆ–é€£ç·š

```go
f, _ := os.Open("file.txt")
defer f.Close()
```

### âœ… å›æ”¶ panicã€éŒ¯èª¤è™•ç†

```go
defer func() {
    if r := recover(); r != nil {
        fmt.Println("Recovered from panic:", r)
    }
}()
```

---

## âš ï¸ å¸¸è¦‹é™·é˜±èˆ‡æ³¨æ„äº‹é …

| å•é¡Œé¡å‹ | èªªæ˜èˆ‡ç¯„ä¾‹ |
|----------|------------|
| âœ… defer ç«‹å³æ±‚å€¼ | å‚³å…¥çš„åƒæ•¸ç•¶ä¸‹å°±è¢«æ±‚å€¼ï¼Œä¸æ˜¯ç­‰åˆ°åŸ·è¡Œ defer æ™‚æ‰ç®— |
| âŒ defer åœ¨è¿´åœˆå…§ | å®¹æ˜“é€ æˆè³‡æºå †ç–Šï¼Œå»ºè­°ä½¿ç”¨é–‰åŒ…å‡½æ•¸é¿å… |
| âš ï¸ åŸ·è¡Œæ•ˆç‡ | defer æœ‰ä¸€å®šæ•ˆèƒ½é–‹éŠ·ï¼Œé »ç¹å‘¼å«å¯èƒ½å½±éŸ¿æ•ˆèƒ½ |

```go
for i := 0; i < 1000; i++ {
    defer fmt.Println(i) // ä¸å»ºè­°é€™æ¨£ç”¨
}
```

---

## ğŸ§  é¢è©¦å¸¸è¦‹é¡Œ

- defer çš„åŸ·è¡Œé †åºæ˜¯ï¼Ÿ
- defer çš„åƒæ•¸æ˜¯ä½•æ™‚æ±‚å€¼ï¼Ÿ
- defer èƒ½å¦ä¿®æ”¹ return çš„å€¼ï¼Ÿ
- åœ¨å“ªè£¡ä½¿ç”¨ defer æœ€é©åˆï¼Ÿ
- defer æœ‰æ•ˆèƒ½å½±éŸ¿å—ï¼Ÿ
- å¦‚ä½•åˆ©ç”¨ defer åšéŒ¯èª¤è™•ç†ï¼Ÿ

---

## ğŸ” è£œå……ï¼šèˆ‡ panic/recover æ­é…ä½¿ç”¨

```go
func main() {
    defer func() {
        if err := recover(); err != nil {
            fmt.Println("panic è¢«æ•æ‰:", err)
        }
    }()

    panic("çˆ†ç‚¸å•¦")
}
```

> ğŸ“Œ defer + recover æ˜¯ Golang ä¸­å¯¦ä½œ try-catch-like çš„æ–¹å¼
