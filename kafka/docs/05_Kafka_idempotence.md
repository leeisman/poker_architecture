# âœ¨ Kafka å¹‚ç­‰æ€§æ©Ÿåˆ¶ (`enable.idempotence=true`)

Kafka Producer çš„å¹‚ç­‰æ€§è¨­å®šå¯ä»¥æœ‰æ•ˆé¿å…é‡é€é€ æˆçš„**é‡è¤‡å¯«å…¥å•é¡Œ**ï¼Œåœ¨é«˜ä½µç™¼èˆ‡ç¶²è·¯ç•°å¸¸æƒ…æ³ä¸‹æä¾›æ›´å®‰å…¨çš„è¨Šæ¯å¯«å…¥ä¿è­‰ã€‚

---

## âœ… åŠŸèƒ½èªªæ˜

| æ©Ÿåˆ¶                    | èªªæ˜                                                                 |
|-------------------------|----------------------------------------------------------------------|
| `Producer ID` (PID)     | Kafka Broker ç‚ºæ¯å€‹ Producer åˆ†é…å”¯ä¸€ IDï¼Œä»¥è­˜åˆ¥è¨Šæ¯ä¾†æºã€‚            |
| `Sequence Number`       | æ¯ç­†è¨Šæ¯éƒ½é™„å¸¶éå¢åºè™Ÿï¼ŒBroker æœƒæª¢æŸ¥åºè™Ÿï¼Œé¿å…è™•ç†èˆŠè¨Šæ¯ã€‚           |
| Exactly-Once-In-Partition (EoPi) | ç¢ºä¿åŒä¸€ Partition å…§è¨Šæ¯åƒ…å¯«å…¥ä¸€æ¬¡ï¼Œå³ä½¿ Producer é‡é€ã€‚      |

---

## ğŸ¯ é©åˆå ´æ™¯

- é‡‘æµè¨˜éŒ„ï¼ˆå¦‚ï¼šæ‰£æ¬¾ã€åŠ å€¼ï¼‰
- éŠæˆ²ç©åˆ†å¯«å…¥
- è¨‚å–®ç‹€æ…‹è®Šæ›´
- é«˜å¯é æ€§è³‡æ–™ç®¡é“

---

## âš  é™åˆ¶èˆ‡æ³¨æ„äº‹é …

- å¹‚ç­‰æ€§åƒ…ä¿è­‰ *Partition å±¤ç´š* çš„ã€ŒExactly Onceã€
- ç„¡æ³•è™•ç†è·¨ Partition çš„å»é‡ï¼ˆéœ€ç”¨ Transaction æ©Ÿåˆ¶ï¼‰
- é–‹å•Ÿå¾Œå°‡è‡ªå‹•å¼·åˆ¶ä»¥ä¸‹è¨­å®šï¼š
  - `acks=all`
  - `retries > 0`
  - `max.in.flight.requests.per.connection <= 5`

---

## ğŸ§ª å¹‚ç­‰ Producer å¯«å…¥æµç¨‹

```mermaid
sequenceDiagram
    participant App as Application
    participant Producer
    participant Broker

    App->>Producer: ç™¼é€è¨Šæ¯ (msgA)
    Producer->>Broker: produce(msgA, seq=101)
    Note over Broker: å¯«å…¥å‰æ–·ç·š/timeout

    App->>Producer: retry msgA
    Producer->>Broker: produce(msgA, seq=101)
    Broker-->>Producer: OKï¼ˆå·²å¯«éï¼Œä¸Ÿæ£„ï¼‰
```
---

## ğŸ” Kafka Producer åºè™Ÿæ§åˆ¶æµç¨‹

```mermaid
sequenceDiagram
    participant Producer
    participant Broker

    Note over Producer: ç™¼é€ msg#1 (seq=0)
    Producer->>Broker: Send msg#1 (seq=0)

    alt ç¬¬ä¸€æ¬¡é€å‡ºæˆåŠŸ
        Broker-->>Producer: ACK OK
        Note over Producer: seq += 1ï¼ˆéå¢ç‚º 1ï¼‰
    else æ–·ç·šé‡é€ msg#1
        Producer->>Broker: Retry msg#1 (seq=0)
        Broker-->>Producer: ä¸Ÿæ£„ï¼ˆé‡è¤‡åºè™Ÿï¼‰
    end
```

---

# âš– Kafka `idempotence` vs Redis åˆ†å¸ƒå¼é–ï¼šå¯é å¯«å…¥çš„å…©ç¨®ç­–ç•¥

## âœ… Kafka `idempotence`

| ç‰¹é»                       | èªªæ˜                                                   |
|----------------------------|--------------------------------------------------------|
| ç³»çµ±ç´šä¿éšœ                 | Kafka å…§å»ºï¼Œé€é Producer ID + Sequence Number ä¿è­‰    |
| é©åˆç”¨æ–¼                   | äº¤æ˜“ç³»çµ±ã€ä»»å‹™æŠ•éã€ä¸å¯é‡è¤‡æ¶ˆè²»çš„äº‹ä»¶æµ                 |
| ä¿è­‰å±¤ç´š                   | é‡é€ä¸æœƒé‡è¤‡ï¼ŒOrdering ä¿æŒï¼ˆå‰æï¼šåŒ partitionï¼‰        |
| æ­é…è¨­å®š                   | éœ€é…åˆ `acks=all`, `max.in.flight <= 5`, é–‹å•Ÿ retries    |
| ç¼ºé»                       | ååé‡æœƒä¸‹é™ï¼Œå»¶é²æœƒæå‡                                |

---

## âœ… Redis åˆ†å¸ƒå¼é– + è‡ªè¨‚é‚è¼¯å»é‡ï¼ˆå¦‚ SETNXï¼‰

| ç‰¹é»                       | èªªæ˜                                                    |
|----------------------------|---------------------------------------------------------|
| å®¢è£½æ§åˆ¶                   | ç¨‹å¼ç¢¼è‡ªè¡Œæ§åˆ¶åŸ·è¡Œæµç¨‹èˆ‡é‡å…¥é‚è¼¯                          |
| é©åˆç”¨æ–¼                   | ç²¾ç°¡å¿«é€Ÿè™•ç†ã€å–®é»é–æ§åˆ¶ï¼Œå¦‚ API è«‹æ±‚æ§åˆ¶ã€è³‡æºäº’æ–¥        |
| ä¿è­‰å±¤ç´š                   | åŸ·è¡Œé‚è¼¯ç”±ä½ è‡ªå·±å®šç¾©ï¼ˆéœ€ä¿è­‰è³‡æ–™ä¸€è‡´æ€§èˆ‡æ¸…é™¤é–æ©Ÿåˆ¶ï¼‰         |
| ç¼ºé»                       | æ˜“è¸©å‘ï¼šé–éºå¤±ã€é–æœªé‡‹æ”¾ã€éåŸå­æ“ä½œéœ€é¡å¤–è™•ç†               |
| å¿«é€Ÿå¯¦ä½œç¯„ä¾‹               | ä½¿ç”¨ `SET key val NX PX 3000` å¯¦ä½œ Redis é–                |

---

## ğŸš€ çµè«–å»ºè­°

| æƒ…å¢ƒé¡å‹     | å»ºè­°ä½¿ç”¨æ–¹æ¡ˆ           |
|--------------|------------------------|
| é«˜ä¸¦ç™¼ & é«˜ä¸€è‡´æ€§è¦æ±‚ | Kafka `idempotence` |
| å¿«é€Ÿç°¡å–®ä»»å‹™é–å®š       | Redis åˆ†å¸ƒå¼é–      |
| ä»»å‹™åŸ·è¡Œæœ‰é‡å…¥é¢¨éšª     | Redis + ID å»é‡é‚è¼¯ |