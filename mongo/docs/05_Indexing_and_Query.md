# 05. Indexing and Query

æœ¬ç« ç¯€èªªæ˜ MongoDB çš„ç´¢å¼•çµæ§‹ã€æŸ¥è©¢è¡Œç‚ºèˆ‡æ•ˆèƒ½é—œè¯ã€‚ä½œç‚º Staff Engineerï¼ŒæŒæ¡ç´¢å¼•è¨­è¨ˆçš„ç­–ç•¥æ˜¯ç³»çµ±æ•ˆèƒ½å„ªåŒ–çš„é—œéµä¹‹ä¸€ã€‚

---

## ğŸ” ç‚ºä»€éº¼éœ€è¦ Indexï¼Ÿ

- æ²’æœ‰ç´¢å¼•æ™‚ï¼ŒæŸ¥è©¢æœƒé€²è¡Œ **collection scan**
- åŠ å…¥ç´¢å¼•å¯å°‡æŸ¥è©¢å¾ O(n) é™ç‚º O(log n)
- æ”¯æ´é«˜æ•ˆçš„ç¯„åœæŸ¥è©¢ã€æ’åºã€å”¯ä¸€æ€§é©—è­‰ç­‰

---

## ğŸ§± ç´¢å¼•ç¨®é¡

| é¡å‹             | èªªæ˜                                           |
|------------------|------------------------------------------------|
| å–®æ¬„ä½ç´¢å¼•       | æœ€å¸¸è¦‹ï¼Œç”¨æ–¼å¸¸æŸ¥è©¢æ¬„ä½                        |
| è¤‡åˆç´¢å¼•         | é‡å°å¤šæ¬„ä½è¨­è¨ˆæŸ¥è©¢é †åºï¼Œå·¦å´æ¬„ä½å¿…é ˆå‘½ä¸­      |
| å”¯ä¸€ç´¢å¼•         | å¼·åˆ¶æ¬„ä½å€¼ä¸èƒ½é‡è¤‡                             |
| TTL ç´¢å¼•         | è¨­å®šè‡ªå‹•éæœŸæ™‚é–“ï¼ˆå¸¸ç”¨æ–¼ log / sessionï¼‰     |
| Hashed ç´¢å¼•      | ç”¨æ–¼ Sharding çš„ shard key                    |
| Text ç´¢å¼•        | æ”¯æ´å…¨æ–‡æœå°‹ï¼ˆä¸æ”¯æ´è¤‡åˆç´¢å¼•ï¼‰               |
| Geospatial ç´¢å¼•  | åœ°ç†ç©ºé–“æœå°‹ï¼Œå¦‚ `$near`, `$geoWithin`        |

---

## ğŸ”§ å»ºç«‹èˆ‡ä½¿ç”¨ç´¢å¼•

```js
db.users.createIndex({ age: 1 }) // éå¢ç´¢å¼•
db.users.createIndex({ name: 1, age: -1 }) // è¤‡åˆç´¢å¼•
db.users.find({ age: { $gt: 18 } }).sort({ name: 1 })
```

å¯ä½¿ç”¨ `explain()` æŸ¥çœ‹æŸ¥è©¢è¨ˆç•«ï¼š

```js
db.users.find({ age: { $gt: 18 } }).explain("executionStats")
```

---

## âš ï¸ ç´¢å¼•è¨­è¨ˆæ³¨æ„äº‹é …

- ä¸å¿…è¦çš„ç´¢å¼•æœƒé™ä½å¯«å…¥æ•ˆèƒ½ï¼ˆæ¯æ¬¡å¯«å…¥éœ€æ›´æ–°ç´¢å¼•ï¼‰
- è¤‡åˆç´¢å¼•éœ€å‘½ä¸­ã€Œæœ€å·¦å‰ç¶´åŸå‰‡ã€
- éå¤šç´¢å¼•æœƒæ¶ˆè€—å¤§é‡è¨˜æ†¶é«”
- Text èˆ‡ Geospatial ç´¢å¼•ç„¡æ³•çµ„åˆä½¿ç”¨

---

## ğŸ“ˆ ç¯„ä¾‹ç´¢å¼•å‘½ä¸­åˆ†æ

```js
db.orders.createIndex({ user_id: 1, created_at: -1 })

// å‘½ä¸­ç´¢å¼• âœ…
db.orders.find({ user_id: 123 }).sort({ created_at: -1 })

// ä¸å‘½ä¸­ç´¢å¼• âŒï¼ˆuser_id æ²’å‡ºç¾åœ¨æŸ¥è©¢æ¢ä»¶ä¸­ï¼‰
db.orders.find({ created_at: { $gt: ISODate(...) } })
```

---

## ğŸ§  Staff Engineer è©²ç†è§£çš„é»

- é¿å… over-indexï¼ˆç´¢å¼•éå¤šï¼‰
- æ‡‰ä¾æ“šæŸ¥è©¢ pattern è¨­è¨ˆç´¢å¼•çµæ§‹
- ç†Ÿæ‚‰ `explain()` å·¥å…·ä¾†åˆ†ææŸ¥è©¢æ•ˆèƒ½ç“¶é ¸
- äº†è§£ shard key ä¹Ÿéœ€è¦è¨­è¨ˆæˆç´¢å¼•

---

[â† å›åˆ°ç¸½è¦½](../Mongo_Summary.md)